generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enum para status de assinatura
enum SubscriptionStatus {
  TRIAL
  ACTIVE
  EXPIRED
  CANCELLED
}

// Enum para planos de assinatura
enum SubscriptionPlan {
  BRONZE    // $99/mês - até 1000 processos
  PRATA     // $159/mês - até 2500 processos
  OURO      // $219/mês - até 5000 processos
}

// Tabela de empresas (tenants)
model Company {
  id        String   @id @default(uuid())
  name      String
  cnpj      String?  @unique
  email     String   @unique
  phone     String?
  address   String?
  city      String?
  state     String?
  zipCode   String?
  logo      String?  // URL do logo da empresa
  apiKey    String?  @unique // API Key para integrações externas (Chatwoot, etc)
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Campos de assinatura Stripe
  subscriptionStatus    SubscriptionStatus @default(TRIAL)
  subscriptionPlan      SubscriptionPlan?
  trialEndsAt           DateTime?          // Quando o trial expira (1 dia após criação)
  stripeCustomerId      String?            // ID do cliente no Stripe
  stripeSubscriptionId  String?            // ID da assinatura no Stripe
  subscriptionEndsAt    DateTime?          // Data de expiração da assinatura atual
  casesLimit            Int                @default(1000) // Limite de processos do plano

  // LGPD - Dados do DPO (Encarregado de Dados)
  dpoName               String?                // Nome do DPO/Encarregado
  dpoEmail              String?                // Email do DPO

  users                 User[]
  clients               Client[]
  cases                 Case[]
  financialTransactions FinancialTransaction[]
  documents             Document[]
  scheduleEvents        ScheduleEvent[]
  accountsPayable       AccountPayable[]
  smtpConfig            SMTPConfig?
  emailCampaigns        EmailCampaign[]
  aiConfig              AIConfig?
  legalDocuments        LegalDocument[]
  stripeConfig          StripeConfig?
  servicePlans          ServicePlan[]
  clientSubscriptions   ClientSubscription[]
  leads                 Lead[]
  dataRequests          DataRequest[]
  auditLogs             AuditLog[]

  @@map("companies")
}

// Enum para níveis de usuário
enum UserRole {
  SUPER_ADMIN
  ADMIN
  USER
}

// Tabela de usuários
model User {
  id                        String    @id @default(uuid())
  companyId                 String?
  name                      String
  email                     String    @unique
  password                  String
  role                      UserRole  @default(USER)
  active                    Boolean   @default(true)
  emailVerified             Boolean   @default(false)
  emailVerificationToken    String?
  emailVerificationExpiry   DateTime?
  resetToken                String?
  resetTokenExpiry          DateTime?
  failedLoginAttempts       Int       @default(0)
  lastFailedLoginAt         DateTime?
  accountLockedUntil        DateTime?

  // Campos de perfil
  phone                     String?   // Telefone fixo
  mobile                    String?   // Celular
  birthDate                 DateTime? // Data de nascimento
  profilePhoto              String?   // Chave S3 da foto de perfil
  profilePhotoUrl           String?   // URL da foto de perfil

  // Configurações de interface
  hideSidebar               Boolean   @default(false) // Esconder sidebar para este usuário

  createdAt                 DateTime  @default(now())
  updatedAt                 DateTime  @updatedAt

  company                 Company?  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  permissions             Permission[]
  documents               Document[]
  scheduleEvents          ScheduleEvent[]
  accountsPayable         AccountPayable[]
  emailCampaigns          EmailCampaign[]
  assignedEvents          EventAssignment[]
  casesAsDeadlineResponsible Case[]  @relation("CaseDeadlineResponsible")
  caseAuditLogs           CaseAuditLog[]
  legalDocumentsSigned    LegalDocument[] @relation("LegalDocumentSigner")
  legalDocumentsCreated   LegalDocument[] @relation("LegalDocumentCreator")
  consentLogs             ConsentLog[]
  dataRequests            DataRequest[]
  auditLogs               AuditLog[]

  @@map("users")
}

// Tabela de permissões
model Permission {
  id        String   @id @default(uuid())
  companyId String?  // Para isolamento direto de tenant (será preenchido automaticamente)
  userId    String
  resource  String   // ex: "clients", "cases", "settings"
  canView   Boolean  @default(false)
  canEdit   Boolean  @default(false)
  canDelete Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, resource])
  @@index([companyId])
  @@map("permissions")
}

// Tabela de clientes
model Client {
  id            String     @id @default(uuid())
  companyId     String
  personType    PersonType @default(FISICA) // Tipo de pessoa: Física ou Jurídica
  name          String
  cpf           String? // CPF para Pessoa Física ou CNPJ para Pessoa Jurídica
  stateRegistration String? // Inscrição Estadual (para Pessoa Jurídica)
  rg            String?
  email         String?
  phone         String?
  address       String?
  city          String?
  state         String?
  zipCode       String?
  profession    String?   // Profissão
  nationality   String?   // Nacionalidade
  maritalStatus String?   // Estado civil
  birthDate     DateTime? // Data de nascimento
  representativeName String? // Nome do representante legal (para Pessoa Jurídica)
  representativeCpf  String? // CPF do representante legal (para Pessoa Jurídica)
  notes         String?
  tag           String?   // Tag/Categoria do cliente
  active        Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  company               Company               @relation(fields: [companyId], references: [id], onDelete: Cascade)
  cases                 Case[]
  financialTransactions FinancialTransaction[]
  documents             Document[]
  scheduleEvents        ScheduleEvent[]
  legalDocuments        LegalDocument[]       @relation("LegalDocumentClient")
  subscriptions         ClientSubscription[]
  leadsConverted        Lead[]                @relation("LeadToClient")

  @@unique([companyId, cpf]) // CPF único por empresa (NULL é permitido para múltiplos clientes)
  @@index([companyId])
  @@index([email])
  @@index([cpf])
  @@index([companyId, createdAt])
  @@index([companyId, cpf]) // Índice para buscas por CPF dentro da empresa
  @@map("clients")
}

// Enum para tipo de pessoa
enum PersonType {
  FISICA
  JURIDICA
}

// Enum para status do processo
enum CaseStatus {
  PENDENTE
  ACTIVE
  ARCHIVED
  FINISHED
}

// Tabela de processos
model Case {
  id                    String     @id @default(uuid())
  companyId             String
  clientId              String
  processNumber         String     // Número do processo (único por empresa)
  court                 String     // Tribunal
  subject               String     // Assunto
  value                 Decimal?   @db.Decimal(15, 2) // Valor da causa
  status                CaseStatus @default(ACTIVE)
  deadline              DateTime?  // Prazo do processo
  deadlineResponsibleId String?    // ID do usuário responsável pelo prazo
  deadlineCompleted     Boolean    @default(false) // Prazo foi cumprido
  deadlineCompletedAt   DateTime?  // Data/hora que o prazo foi marcado como cumprido
  notes                 String?
  ultimoAndamento       String?    // Último movimento do processo (atualizado via API)
  informarCliente       String?    @db.Text // Texto explicativo do andamento para informar ao cliente
  linkProcesso          String?    // Link/URL do processo no tribunal
  aiSummary             String?    @db.Text // Resumo gerado por IA dos movimentos do processo
  createdAt             DateTime   @default(now())
  updatedAt             DateTime   @updatedAt
  lastSyncedAt          DateTime?  // Última sincronização com DataJud
  lastAcknowledgedAt    DateTime?  // Última vez que o advogado marcou como "ciente" das atualizações

  company               Company               @relation(fields: [companyId], references: [id], onDelete: Cascade)
  client                Client                @relation(fields: [clientId], references: [id], onDelete: Cascade)
  deadlineResponsible   User?                 @relation("CaseDeadlineResponsible", fields: [deadlineResponsibleId], references: [id], onDelete: SetNull)
  movements             CaseMovement[]
  caseDocuments         CaseDocument[]        @relation("CaseDocuments")
  parts                 CasePart[]
  financialTransactions FinancialTransaction[]
  documents             Document[]
  scheduleEvents        ScheduleEvent[]
  auditLogs             CaseAuditLog[]

  @@unique([companyId, processNumber]) // Único por empresa
  @@index([companyId])
  @@index([companyId, status])
  @@index([clientId])
  @@map("cases")
}

// Tabela de movimentações do processo
model CaseMovement {
  id              String   @id @default(uuid())
  caseId          String
  movementCode    Int
  movementName    String
  movementDate    DateTime
  description     String?
  createdAt       DateTime @default(now())

  case            Case     @relation(fields: [caseId], references: [id], onDelete: Cascade)

  @@index([caseId])
  @@index([movementDate])
  @@map("case_movements")
}

// Tabela de documentos do processo
model CaseDocument {
  id          String   @id @default(uuid())
  caseId      String
  name        String
  s3Key       String   // Chave do arquivo no S3
  s3Url       String   // URL do arquivo no S3
  fileSize    Int
  mimeType    String
  createdAt   DateTime @default(now())

  case        Case     @relation("CaseDocuments", fields: [caseId], references: [id], onDelete: Cascade)

  @@map("case_documents")
}

// Enum para tipo de parte do processo
enum CasePartType {
  AUTOR                // Autor/Requerente
  REU                  // Réu/Requerido
  REPRESENTANTE_LEGAL  // Representante Legal
}

// Tabela de partes do processo (Autor, Réu, Representante Legal)
model CasePart {
  id              String       @id @default(uuid())
  caseId          String
  type            CasePartType

  // Campos comuns
  name            String
  cpfCnpj         String?      // CPF ou CNPJ
  phone           String?
  address         String?

  // Campos específicos para AUTOR
  email           String?
  civilStatus     String?      // Estado civil
  profession      String?      // Profissão
  rg              String?      // RG
  birthDate       DateTime?    // Data de nascimento

  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  case            Case         @relation(fields: [caseId], references: [id], onDelete: Cascade)

  @@map("case_parts")
}

// Tabela de auditoria de processos (histórico de ações)
model CaseAuditLog {
  id          String   @id @default(uuid())
  caseId      String
  userId      String
  action      String   // CREATED, STATUS_CHANGED, PART_ADDED, PART_UPDATED, PART_DELETED, DOCUMENT_ADDED, DEADLINE_SET, DEADLINE_RESPONSIBLE_SET, etc.
  description String   // Descrição legível da ação
  metadata    Json?    // Dados adicionais (valores antigos/novos, etc.)
  createdAt   DateTime @default(now())

  case        Case     @relation(fields: [caseId], references: [id], onDelete: Cascade)
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("case_audit_logs")
  @@index([caseId])
}

// Tabela de configurações do sistema
model SystemConfig {
  id        String   @id @default(uuid())
  key       String   @unique
  value     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("system_config")
}

// Enum para tipo de transação financeira
enum TransactionType {
  INCOME    // Recebimento
  EXPENSE   // Despesa
}

// Tabela de transações financeiras
model FinancialTransaction {
  id          String          @id @default(uuid())
  companyId   String
  clientId    String
  caseId      String?         // Opcional - pode não estar vinculado a um processo
  type        TransactionType
  description String
  amount      Decimal         @db.Decimal(15, 2) // Valor total da transação
  date        DateTime        @default(now())

  // Campos de parcelamento
  isInstallment       Boolean  @default(false)  // Se é uma transação parcelada
  installmentCount    Int?                      // Número total de parcelas
  installmentInterval Int?     @default(30)     // Intervalo em dias entre parcelas (padrão 30 = mensal)

  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  company      Company         @relation(fields: [companyId], references: [id], onDelete: Cascade)
  client       Client          @relation(fields: [clientId], references: [id], onDelete: Cascade)
  case         Case?           @relation(fields: [caseId], references: [id], onDelete: SetNull)
  installments InstallmentPayment[]  // Relação com parcelas

  @@index([companyId])
  @@index([clientId])
  @@index([caseId])
  @@index([type])
  @@index([date])
  @@index([companyId, date])
  @@map("financial_transactions")
}

// Enum para status de parcelas
enum InstallmentStatus {
  PENDING    // Pendente
  PAID       // Pago
  OVERDUE    // Atrasado
  CANCELLED  // Cancelado
}

// Tabela de parcelas de pagamento/recebimento
model InstallmentPayment {
  id                      String             @id @default(uuid())
  financialTransactionId  String
  installmentNumber       Int                // Número da parcela (1, 2, 3...)
  amount                  Decimal            @db.Decimal(15, 2) // Valor da parcela
  dueDate                 DateTime           // Data de vencimento
  paidDate                DateTime?          // Data de pagamento (quando pago)
  paidAmount              Decimal?           @db.Decimal(15, 2) // Valor efetivamente pago (pode diferir do valor da parcela)
  status                  InstallmentStatus  @default(PENDING)
  notes                   String?            // Observações sobre a parcela
  receiptUrl              String?            // URL do recibo/comprovante em PDF
  createdAt               DateTime           @default(now())
  updatedAt               DateTime           @updatedAt

  financialTransaction    FinancialTransaction @relation(fields: [financialTransactionId], references: [id], onDelete: Cascade)

  @@map("installment_payments")
}

// Enum para tipo de armazenamento de documentos
enum StorageType {
  upload    // Arquivo carregado no S3
  link      // Link externo
}

// Enum para tipo de link externo
enum ExternalType {
  google_drive
  google_docs
  minio
  other
}

// Tabela de documentos gerais (novos - diferente de CaseDocument)
model Document {
  id          String        @id @default(uuid())
  companyId   String

  // Relacionamentos (um dos dois é obrigatório)
  caseId      String?
  clientId    String?

  // Dados do documento
  name        String
  description String?

  // Tipo de armazenamento
  storageType StorageType

  // Para documentos carregados (storage_type = 'upload')
  fileUrl     String?       // URL no S3
  fileKey     String?       // Key no S3
  fileSize    Int?          // Tamanho em bytes
  fileType    String?       // MIME type

  // Para links externos (storage_type = 'link')
  externalUrl  String?
  externalType ExternalType?

  // Metadados
  uploadedBy  String?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  // Relations
  company     Company       @relation(fields: [companyId], references: [id], onDelete: Cascade)
  case        Case?         @relation(fields: [caseId], references: [id], onDelete: Cascade)
  client      Client?       @relation(fields: [clientId], references: [id], onDelete: Cascade)
  user        User?         @relation(fields: [uploadedBy], references: [id], onDelete: SetNull)

  @@index([companyId])
  @@index([clientId])
  @@index([caseId])
  @@index([storageType])
  @@map("documents")
}

// Enum para tipo de evento na agenda
enum ScheduleEventType {
  COMPROMISSO  // Reunião, encontro
  TAREFA       // Tarefa interna
  PRAZO        // Prazo processual
  AUDIENCIA    // Audiência judicial
  GOOGLE_MEET  // Reunião Google Meet
}

enum Priority {
  BAIXA      // Prioridade baixa
  MEDIA      // Prioridade média
  ALTA       // Prioridade alta
  URGENTE    // Urgente
}

// Tabela de eventos da agenda
model ScheduleEvent {
  id          String            @id @default(uuid())
  companyId   String

  // Dados do evento
  title       String
  description String?
  type        ScheduleEventType @default(COMPROMISSO)
  priority    Priority          @default(MEDIA)

  // Data e hora
  date        DateTime
  endDate     DateTime?         // Data/hora de término (opcional)

  // Relacionamentos (opcionais)
  clientId    String?
  caseId      String?

  // Status e responsável
  completed   Boolean           @default(false)
  createdBy   String?           // Quem criou o evento

  // Google Meet
  googleMeetLink String?         // Link do Google Calendar para criar reunião com Google Meet

  // Metadados
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  // Relations
  company     Company           @relation(fields: [companyId], references: [id], onDelete: Cascade)
  client      Client?           @relation(fields: [clientId], references: [id], onDelete: Cascade)
  case        Case?             @relation(fields: [caseId], references: [id], onDelete: Cascade)
  user        User?             @relation(fields: [createdBy], references: [id], onDelete: SetNull)
  assignedUsers EventAssignment[]

  @@index([companyId])
  @@index([date])
  @@index([type])
  @@index([companyId, date])
  @@map("schedule_events")
}

// Tabela intermediária para atribuição de usuários a eventos
model EventAssignment {
  id        String        @id @default(uuid())
  eventId   String
  userId    String
  createdAt DateTime      @default(now())

  event     ScheduleEvent @relation(fields: [eventId], references: [id], onDelete: Cascade)
  user      User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([eventId, userId])
  @@map("event_assignments")
}

// Enum para status de conta a pagar
enum AccountPayableStatus {
  PENDING   // Pendente
  PAID      // Pago
  OVERDUE   // Atrasado
  CANCELLED // Cancelado
}

enum RecurrencePeriod {
  DAYS_15  // 15 dias
  DAYS_30  // 30 dias (mensal)
  MONTHS_6 // 6 meses (semestral)
  YEAR_1   // 1 ano (anual)
}

// Tabela de contas a pagar
model AccountPayable {
  id          String               @id @default(uuid())
  companyId   String

  // Dados da conta
  supplier    String               // Fornecedor/Credor
  description String               // Descrição da conta
  amount      Decimal              @db.Decimal(15, 2) // Valor
  dueDate     DateTime             // Data de vencimento
  paidDate    DateTime?            // Data de pagamento (quando pago)
  status      AccountPayableStatus @default(PENDING)
  category    String?              // Categoria (ex: Aluguel, Salários, etc)
  notes       String?              // Observações

  // Recorrência
  isRecurring       Boolean?           @default(false)  // Se é uma conta recorrente
  recurrencePeriod  RecurrencePeriod?                   // Período de recorrência
  parentId          String?                             // ID da conta original (para rastreamento)

  // Metadados
  createdBy   String?              // Quem criou
  createdAt   DateTime             @default(now())
  updatedAt   DateTime             @updatedAt

  // Relations
  company     Company              @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user        User?                @relation(fields: [createdBy], references: [id], onDelete: SetNull)

  @@index([companyId])
  @@index([dueDate])
  @@index([status])
  @@index([companyId, dueDate])
  @@map("accounts_payable")
}

// ============================================================================
// AI INTEGRATION SYSTEM
// ============================================================================

// Enum para providers de IA
enum AIProvider {
  openai      // OpenAI (GPT-4, GPT-4o, GPT-4o-mini)
  gemini      // Google Gemini (Gemini 1.5 Pro/Flash)
  anthropic   // Anthropic Claude (Claude 3.5 Sonnet)
  groq        // Groq (Llama, Mixtral)
}

// Tabela de configuração de IA por empresa
model AIConfig {
  id              String     @id @default(uuid())
  companyId       String     @unique
  provider        AIProvider
  apiKey          String     // Criptografado com AES-256
  model           String     // Nome do modelo específico (ex: gpt-4o-mini, gemini-1.5-flash)
  enabled         Boolean    @default(true)
  autoSummarize   Boolean    @default(true)  // Gerar resumo automaticamente após sync
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt

  // Relations
  company         Company    @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@map("ai_configs")
}

// ============================================================================
// EMAIL CAMPAIGN SYSTEM
// ============================================================================

// SMTP Configuration per Company
model SMTPConfig {
  id         String   @id @default(uuid())
  companyId  String
  host       String
  port       Int
  user       String
  password   String   // Encrypted with AES-256
  fromEmail  String
  fromName   String?
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  company    Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([companyId])
  @@map("smtp_configs")
}

// Campaign Status
enum CampaignStatus {
  draft
  sending
  completed
  failed
  cancelled
}

// Email Campaigns
model EmailCampaign {
  id              String         @id @default(uuid())
  companyId       String
  name            String
  subject         String
  body            String         @db.Text // HTML content
  status          CampaignStatus @default(draft)
  totalRecipients Int            @default(0)
  sentCount       Int            @default(0)
  failedCount     Int            @default(0)
  scheduledAt     DateTime?
  sentAt          DateTime?
  createdBy       String?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  // Relations
  company         Company                @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user            User?                  @relation(fields: [createdBy], references: [id], onDelete: SetNull)
  recipients      CampaignRecipient[]

  @@index([companyId])
  @@index([status])
  @@map("email_campaigns")
}

// Recipient Status
enum RecipientStatus {
  pending
  sent
  failed
}

// Campaign Recipients
model CampaignRecipient {
  id             String          @id @default(uuid())
  campaignId     String
  recipientEmail String
  recipientName  String?
  status         RecipientStatus @default(pending)
  sentAt         DateTime?
  errorMessage   String?         @db.Text
  createdAt      DateTime        @default(now())

  // Relations
  campaign       EmailCampaign   @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  @@map("campaign_recipients")
}

// ============================================================================
// CLIENT SUBSCRIPTION PLANS SYSTEM (Stripe)
// ============================================================================

// Configuração Stripe por empresa (chaves API do escritório)
model StripeConfig {
  id                    String   @id @default(uuid())
  companyId             String   @unique
  stripePublicKey       String   // pk_live_... ou pk_test_...
  stripeSecretKey       String   // Criptografado com AES-256 (sk_live_... ou sk_test_...)
  stripeWebhookSecret   String?  // Criptografado (whsec_...)
  isActive              Boolean  @default(true)
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  company               Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@map("stripe_configs")
}

// Enum para intervalo de cobrança
enum BillingInterval {
  MONTHLY   // Mensal
  QUARTERLY // Trimestral
  YEARLY    // Anual
}

// Planos/Serviços oferecidos pelo escritório
model ServicePlan {
  id                String          @id @default(uuid())
  companyId         String
  name              String          // Ex: "Assessoria Jurídica Básica"
  description       String?
  price             Decimal         @db.Decimal(15, 2) // Valor em reais (ex: 500.00)
  interval          BillingInterval @default(MONTHLY)
  stripeProductId   String?         // ID do produto no Stripe (prod_...)
  stripePriceId     String?         // ID do preço no Stripe (price_...)
  isActive          Boolean         @default(true)
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt

  company           Company         @relation(fields: [companyId], references: [id], onDelete: Cascade)
  subscriptions     ClientSubscription[]

  @@index([companyId])
  @@index([isActive])
  @@map("service_plans")
}

// Enum para status de assinatura do cliente
enum ClientSubscriptionStatus {
  ACTIVE        // Assinatura ativa
  PAST_DUE      // Pagamento atrasado
  CANCELED      // Cancelado
  UNPAID        // Não pago
  INCOMPLETE    // Aguardando primeiro pagamento
  TRIALING      // Em período de teste
}

// Assinatura de cliente em um plano
model ClientSubscription {
  id                    String                   @id @default(uuid())
  companyId             String
  clientId              String
  servicePlanId         String
  stripeCustomerId      String?                  // ID do cliente no Stripe (cus_...)
  stripeSubscriptionId  String?                  // ID da assinatura no Stripe (sub_...)
  status                ClientSubscriptionStatus @default(INCOMPLETE)
  currentPeriodStart    DateTime?                // Início do período atual
  currentPeriodEnd      DateTime?                // Fim do período atual
  canceledAt            DateTime?                // Data de cancelamento
  cancelReason          String?                  // Motivo do cancelamento
  createdAt             DateTime                 @default(now())
  updatedAt             DateTime                 @updatedAt

  company               Company                  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  client                Client                   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  servicePlan           ServicePlan              @relation(fields: [servicePlanId], references: [id], onDelete: Cascade)
  payments              SubscriptionPayment[]

  @@unique([clientId, servicePlanId])  // Cliente só pode ter uma assinatura por plano
  @@index([companyId])
  @@index([clientId])
  @@index([status])
  @@index([companyId, status])
  @@map("client_subscriptions")
}

// Histórico de pagamentos de assinatura
model SubscriptionPayment {
  id                    String                 @id @default(uuid())
  clientSubscriptionId  String
  stripeInvoiceId       String?                // ID da fatura no Stripe (in_...)
  stripePaymentIntentId String?                // ID do pagamento no Stripe (pi_...)
  amount                Decimal                @db.Decimal(15, 2) // Valor pago
  currency              String                 @default("brl")
  status                String                 // paid, failed, pending, refunded
  paidAt                DateTime?              // Data do pagamento
  failedAt              DateTime?              // Data da falha (se aplicável)
  failureReason         String?                // Motivo da falha
  receiptUrl            String?                // URL do recibo do Stripe
  createdAt             DateTime               @default(now())

  clientSubscription    ClientSubscription     @relation(fields: [clientSubscriptionId], references: [id], onDelete: Cascade)

  @@map("subscription_payments")
}

// ============================================================================
// LEAD MANAGEMENT SYSTEM
// ============================================================================

// Enum para status do lead
enum LeadStatus {
  NOVO          // Lead recém-criado
  CONTATADO     // Lead foi contatado
  QUALIFICADO   // Lead qualificado para conversão
  CONVERTIDO    // Convertido para cliente
  PERDIDO       // Lead perdido/não interessado
}

// Enum para origem do lead
enum LeadSource {
  WHATSAPP      // Via WhatsApp
  TELEFONE      // Ligação telefônica
  SITE          // Formulário do site
  INDICACAO     // Indicação de cliente
  REDES_SOCIAIS // Instagram, Facebook, etc
  OUTROS        // Outras origens
}

// Tabela de leads (potenciais clientes)
model Lead {
  id                  String      @id @default(uuid())
  companyId           String

  // Dados do lead
  name                String
  phone               String      // Telefone é obrigatório para verificar se é cliente existente
  email               String?
  contactReason       String?     @db.Text  // Motivo do contato/resumo do atendimento

  // Status e origem
  status              LeadStatus  @default(NOVO)
  source              LeadSource  @default(WHATSAPP)

  // Observações adicionais
  notes               String?     @db.Text

  // Conversão para cliente
  convertedToClientId String?     // ID do cliente se convertido
  convertedAt         DateTime?   // Data da conversão

  // Metadados
  createdAt           DateTime    @default(now())
  updatedAt           DateTime    @updatedAt

  // Relations
  company             Company     @relation(fields: [companyId], references: [id], onDelete: Cascade)
  convertedToClient   Client?     @relation("LeadToClient", fields: [convertedToClientId], references: [id], onDelete: SetNull)

  @@index([companyId])
  @@index([phone])
  @@index([status])
  @@index([companyId, status])
  @@map("leads")
}

// ============================================================================
// LEGAL DOCUMENTS SYSTEM
// ============================================================================

// Tabela de documentos jurídicos (recibos, contratos, procurações, etc.)
model LegalDocument {
  id          String   @id @default(uuid())
  companyId   String

  // Dados do documento
  title       String                    // Título do documento (ex: "Recibo de Honorários")
  content     String   @db.Text         // Conteúdo/texto do documento
  documentDate DateTime @default(now()) // Data do documento

  // Relacionamentos
  clientId    String?                   // Cliente relacionado (parte)
  signerId    String?                   // Profissional que assina

  // Metadados
  createdBy   String?                   // Quem criou
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  company     Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  client      Client?  @relation("LegalDocumentClient", fields: [clientId], references: [id], onDelete: SetNull)
  signer      User?    @relation("LegalDocumentSigner", fields: [signerId], references: [id], onDelete: SetNull)
  creator     User?    @relation("LegalDocumentCreator", fields: [createdBy], references: [id], onDelete: SetNull)

  @@map("legal_documents")
}

// ============================================================================
// LGPD COMPLIANCE SYSTEM
// ============================================================================

// Enum para tipo de consentimento
enum ConsentType {
  PRIVACY_POLICY      // Política de Privacidade
  TERMS_OF_USE        // Termos de Uso
  MARKETING_EMAIL     // Consentimento para emails marketing
  DATA_PROCESSING     // Processamento de dados específico
}

// Tabela de registro de consentimentos (LGPD Art. 8)
model ConsentLog {
  id            String       @id @default(uuid())

  // Tenant (opcional para consentimentos de registro)
  companyId     String?      // Para isolamento de tenant (preenchido para consentimentos pós-login)

  // Quem deu o consentimento
  userId        String?      // Usuário autenticado (opcional para leads/registro)
  email         String       // Email para rastreamento
  ip            String?      // IP do cliente
  userAgent     String?      // User agent do navegador

  // O que foi consentido
  consentType   ConsentType
  version       String       // Versão do documento (ex: "1.0", "2.0")

  // Quando
  consentedAt   DateTime     @default(now())
  revokedAt     DateTime?    // Se foi revogado

  // Metadados
  documentHash  String?      // Hash SHA-256 do documento aceito

  createdAt     DateTime     @default(now())

  // Relations
  user          User?        @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([companyId])
  @@index([userId])
  @@index([email])
  @@index([consentType])
  @@map("consent_logs")
}

// Enum para tipo de solicitação LGPD
enum DataRequestType {
  ACCESS          // Acesso aos dados (Art. 18, II)
  CORRECTION      // Correção de dados (Art. 18, III)
  DELETION        // Exclusão de dados (Art. 18, VI)
  PORTABILITY     // Portabilidade (Art. 18, V)
  REVOKE_CONSENT  // Revogação de consentimento (Art. 18, IX)
}

// Enum para status de solicitação LGPD
enum DataRequestStatus {
  PENDING         // Aguardando processamento
  IN_PROGRESS     // Em processamento
  COMPLETED       // Concluído
  REJECTED        // Rejeitado (com justificativa)
}

// Tabela de solicitações de direitos do titular (LGPD Art. 18)
model DataRequest {
  id            String            @id @default(uuid())
  userId        String
  companyId     String

  // Tipo e status
  requestType   DataRequestType
  status        DataRequestStatus @default(PENDING)

  // Descrição da solicitação (para correções ou especificações)
  description   String?           @db.Text

  // Datas
  requestedAt   DateTime          @default(now())
  processedAt   DateTime?         // Quando começou a ser processado
  completedAt   DateTime?         // Quando foi concluído

  // Resultado
  resultUrl     String?           // URL do arquivo gerado (portabilidade)
  notes         String?           @db.Text  // Notas do processamento
  processedBy   String?           // ID do admin que processou
  rejectionReason String?         @db.Text  // Motivo da rejeição (se aplicável)

  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt

  // Relations
  user          User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  company       Company           @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([companyId])
  @@index([status])
  @@index([requestType])
  @@map("data_requests")
}

// ============================================================================
// AUDIT LOG SYSTEM (Sistema de Auditoria)
// ============================================================================

// Enum para tipo de entidade auditada
enum AuditEntityType {
  CLIENT    // Clientes
  CASE      // Processos
}

// Enum para ação de auditoria
enum AuditAction {
  CREATE    // Criação
  UPDATE    // Atualização
  DELETE    // Exclusão
}

// Tabela de logs de auditoria genérica
model AuditLog {
  id            String          @id @default(uuid())
  companyId     String

  // Entidade afetada
  entityType    AuditEntityType
  entityId      String
  entityName    String?         // Nome para exibição (ex: nome do cliente, número do processo)

  // Quem fez
  userId        String
  userName      String?         // Snapshot do nome do usuário no momento da ação

  // O que fez
  action        AuditAction
  description   String?         // Descrição legível da ação

  // Dados da alteração
  oldValues     Json?           // Valores antes da alteração
  newValues     Json?           // Valores depois da alteração
  changedFields String[]        @default([])  // Lista de campos alterados

  // Contexto da requisição
  ipAddress     String?
  userAgent     String?

  createdAt     DateTime        @default(now())

  // Relations
  company       Company         @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user          User            @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([companyId])
  @@index([entityType, entityId])
  @@index([userId])
  @@index([createdAt])
  @@index([companyId, entityType])
  @@index([companyId, createdAt])
  @@map("audit_logs")
}
